<html>

<body>

	<head>
		<script src="jquery-3.3.1.min.js"></script>
	</head>
	<h5>Entre com o codigo...</h5>
	<textarea id="codigo" name="codigo" rows="20" cols="60">
main()
{
    int a = 1, b=2, c;
    char t, y = 's';
    float r = 1.2, y;
    double ty = 4.321412;
    a=b+c;
    if(a>b)
    {
        char t, y = 't';
        int a1 = 5, b, c3 = 7;
        t=t+y;
        a=b*t;
    }
    int d;    
}  
</textarea>
	</br>

	<script src="jquery-3.3.1.min.js"></script>

	<script>

		var i = 0;
		var arvoreSimbolo = [];
		var arvoreAtribuicao = [];

		Analisador();

		function Analisador() {
			return montaArvoreSimbolos();
		}

		function montarArvoreSimboloTemp(codigo, tipo, contexto) {
			i = i + 6;
			var nome = "";
			var valor = "";
			while (codigo.charAt(i) != ";") {
				var x = codigo.charAt(i);
				if (codigo.charAt(i) != "=" && codigo.charAt(i) != ",")
					nome = nome + codigo.charAt(i);

				if (codigo.charAt(i) == "=") {
					i++;
					valor = "";
					while (codigo.charAt(i) != "," && codigo.charAt(i) != ";") {
						if (codigo.charAt(i) != "'")
							valor = valor + codigo.charAt(i);
						i++;
					}
				}

				if (codigo.charAt(i) == ",") {
					nome = nome.trim();
					valor = valor != "" ? valor.trim() : valor;
					arvoreSimbolo[contexto].push([nome, tipo, valor]);
					nome = "";
					valor = "";
				}

				if (codigo.charAt(i) == ";")
					i--;
				i++;
			}
			nome = nome.trim();
			valor = valor != "" ? valor.trim() : valor;
			arvoreSimbolo[contexto].push([nome, tipo, valor]);
		}

		function montaArvoreSimbolos() {
			var contexto = -1;
			var codigo = $('#codigo').val().replace(/(\r\n|\n|\r)/gm, "");

			while (i < codigo.length) {

				var tipo = (codigo.charAt(i) + codigo.charAt(i + 1) + codigo.charAt(i + 2) + codigo.charAt(i + 3) + codigo.charAt(i + 4) + codigo.charAt(i + 5)).trim();
				var teste = codigo.charAt(i);

				if (tipo == "int") {
					montarArvoreSimboloTemp(codigo, tipo, contexto);
				}

				if (tipo == "char") {
					montarArvoreSimboloTemp(codigo, tipo, contexto);
				}

				if (tipo == "float") {
					montarArvoreSimboloTemp(codigo, tipo, contexto);
				}

				if (tipo == "double") {
					montarArvoreSimboloTemp(codigo, tipo, contexto);
				}

				tipo = "";
				if (codigo.charAt(i) == "{") {
					if (contexto == -1) {
						contexto++;
						arvoreSimbolo.push([]);
					}
					else {
						arvoreSimbolo.push([]);
						contexto += 1;
					}
				}

				if (codigo.charAt(i) == "}") {
					contexto -= 1;
				}


				i++;
			}

			console.log(arvoreSimbolo);
			arvoreSemantica();
			return arvoreSimbolo;
		}

		function arvoreSemantica() {
			var codigoParticinado = "";

			codigoParticinado = codigo.textContent.replace(/(\r\n|\n|\r)/gm, "");

			codigoParticinado = codigoParticinado.replace(/=/g, " EQUAL ");

			codigoParticinado = codigoParticinado.replace(/\+/g, " ADD ");

			codigoParticinado = codigoParticinado.replace(/\-/g, " SUB ");

			codigoParticinado = codigoParticinado.replace(/\*/g, " MULT ");

			codigoParticinado = codigoParticinado.replace(/\//g, " DIV ");

			codigoParticinado = codigoParticinado.replace(/;/g, " ; ");

			codigoParticinado = codigoParticinado.replace(/,/g, " , ");

			arvoreAtribuicao = codigoParticinado.split(" ");

			arvoreAtribuicao = arvoreAtribuicao.filter(item => item !== "")

			var contexto = 0;

			var numeros = ["int", "float", "double"];

			arvoreAtribuicao.forEach(function (item, index) {
				if (item == "{")
					contexto++;
				if (item == "}")
					contexto--;

				var recebedorTipo = "";
				var operacoesTipo = "";

				if (item == "EQUAL" && arvoreAtribuicao[index + 2] != "," && arvoreAtribuicao[index + 2] != ";") {
					debugger;
					recebedorTipo = arvoreSimbolo[contexto].filter(itemBusca => itemBusca[0] == arvoreAtribuicao[index - 1]);
					recebedorTipo.length != 0 ? recebedorTipo = recebedorTipo[0][1] : recebedorTipo = "erro";

					operacoesTipo = arvoreSimbolo[contexto].filter(itemBusca => itemBusca[0] == arvoreAtribuicao[index + 1]);
					recebedorTipo.length != 0 ? operacoesTipo = operacoesTipo[0][1] : operacoesTipo = "erro";

					if ((numeros.indexOf(recebedorTipo) != -1 && operacoesTipo == "char") || (recebedorTipo == "char" && numeros.indexOf(operacoesTipo) != -1) || operacoesTipo == "erro" || recebedorTipo == "erro")
						return false;
					console.log(item);
				}

				if (recebedorTipo != "") {
					i = 0;
					while (arvoreAtribuicao[index + 1] != ";") {
						debugger;
						var rt = arvoreAtribuicao[index + 1];

						arvoreSimbolo[contexto].forEach(function (it) {
							if (it[0] == arvoreAtribuicao[index + 1] && operacoesTipo == it[1])
								operacoesTipo = it[1];

							else if(it[0] == arvoreAtribuicao[index + 1] && operacoesTipo != it[1]) {
								operacoesTipo = "fim"
								return false;
							}
						});
						index++;
					}
					recebedorTipo = "";
					operacoesTipo = "";

				}

			});


		}



	</script>

</body>

</html>